#!/bin/bash

# Array of IP addresse
declare -a ip_addresses=("34.56.189.148" "35.222.146.158" "35.203.148.217" "34.169.211.250" "35.230.12.25" "34.83.65.90" "35.203.154.16" "35.190.156.71" "34.74.84.161" "35.245.148.98" "34.86.7.236" "34.57.229.61" "34.56.56.237" "34.136.41.222" "34.173.151.128" "35.227.9.72" "34.138.107.118" "34.170.8.105" "104.198.17.31" "35.199.22.92" "34.85.219.155" "34.83.209.108" "35.227.180.152" "34.48.76.240" "34.85.160.200" "34.73.13.87" "35.237.151.9" "34.82.87.201" "34.53.125.185" "34.85.197.251" "34.85.166.141" "34.19.30.170" "34.168.51.10" "34.42.50.177" "35.226.85.202" "34.85.228.12" "35.245.148.240" "34.19.34.150" "34.53.63.70" "34.127.119.212" "35.230.14.201" "35.227.166.42" "34.105.1.223" "35.247.49.98" "34.169.11.108" "34.86.112.59" "34.85.198.13" "104.155.169.149" "34.121.59.132" "34.75.39.149" "34.74.244.34" "34.145.63.253" "34.168.229.59" "34.48.73.166" "34.150.159.215" "34.66.224.172" "34.173.88.59" "34.61.192.33" "34.29.132.45" "35.196.166.187" "34.148.153.53" "35.231.125.89" "34.48.157.74" "34.139.80.59" "35.245.146.104" "34.19.68.171" "34.139.47.135" "34.169.190.199" "35.185.61.110" "34.148.219.125" "104.196.182.224" "34.46.9.159" "34.132.185.202" "35.197.49.187" "35.197.74.218" "35.185.241.195" "34.127.38.76" "35.245.117.101" "34.86.75.87" "34.145.201.101" "35.245.157.128" "35.229.43.169" "34.75.61.111" "34.75.84.47" "34.139.83.234" "34.23.210.208" "34.75.142.125" "34.83.143.3" "34.53.33.75" "34.82.147.130" "35.233.175.75" "34.85.197.195" "34.21.52.89" "34.169.254.79" "34.83.166.60" "34.169.201.38" "35.199.171.102" "35.197.89.215" "35.236.231.162" "35.233.185.243" "34.73.101.93" "34.48.116.152" "35.245.75.40" "34.85.230.238" "35.231.46.100" "35.227.40.130" "34.48.141.187" "35.186.184.194" "34.21.99.209" "35.186.166.37" "35.203.180.128" "35.230.12.45" "34.44.116.254" "34.86.48.37" "34.123.107.149" "35.245.155.144" "34.63.9.182" "34.121.76.5" "35.197.43.165" "34.127.31.68" "34.83.36.182" "34.105.67.7" "34.46.25.236" "35.236.212.174" "34.29.212.11" "34.145.54.189" "34.86.197.235" "34.41.178.148" "35.225.100.178" "34.72.222.102" "34.105.105.153" "34.169.158.110" "34.134.99.167" "34.27.7.66" "35.237.118.171" "35.196.255.138" "35.199.15.62" "34.21.43.185" "35.231.186.169" "104.196.107.146" "34.139.113.248" "34.138.77.184" "35.231.113.158" "34.73.15.57" "34.48.113.101" "35.230.169.52" "34.48.55.194" "34.145.218.216" "34.86.109.44" "35.245.142.69" "34.168.137.250" "34.83.236.56" "34.139.206.71" "34.139.58.166" "35.224.155.119" "34.135.161.227" "34.23.217.149" "34.74.125.232" "35.236.206.14" "35.221.36.19" "34.85.143.72" "34.145.253.230" "34.86.7.8" "34.48.103.237" "34.145.115.199" "34.53.111.171" "35.229.81.80" "35.231.18.4" "34.136.40.230" "34.61.19.4" "35.229.105.223" "34.148.215.206" "104.196.207.89" "35.229.120.52" "34.133.185.133" "34.123.16.26" "34.75.21.1" "35.231.90.25" "35.237.9.151" "34.148.193.116" "35.245.204.149" "34.86.142.151" "34.85.230.206" "35.245.102.168" "34.148.200.72" "34.74.109.29" "34.61.183.15" "34.31.53.192" "34.86.218.110" "35.230.189.59" "34.169.148.44" "35.247.106.36" "35.237.50.96" "35.227.109.209" "35.243.138.43" "35.231.96.177" "35.227.52.102" "34.138.106.178" "34.74.172.23" "34.139.85.95")

# Base domain name and timestamp
base_domain="ayoyo-studentart.fun"
timestamp=$(date +%m%d%H%M)

# Find the last used port
last_port=$(ss -tln | grep -oE ':1[0-9]{4}' | sed 's/://' | sort -n | tail -n 1)
if [ -z "$last_port" ]; then
    start_port=10000
else
    start_port=$((last_port + 1))
fi

echo "Setting up servers for session ${timestamp}..."
echo "Starting from port: ${start_port}"
echo "-------------------"

# Loop through the IP addresses and create host entries
for i in "${!ip_addresses[@]}"; do
    server_num=$((i + 1))  # Starting from 1
    current_port=$((start_port + i))
    host_alias="s${current_port}-${base_domain}"
    # echo "${ip_addresses[$i]} ${host_alias}" | sudo tee -a /etc/hosts

    # Create shadowsocks config for each server
    config_file="/etc/shadowsocks/${current_port}.json"
    sudo tee "$config_file" > /dev/null <<EOF
{
    "server": "${ip_addresses[$i]}",
    "server_port": 8388,
    "password": "Pass",
    "method": "aes-128-gcm",
    "mode": "tcp_and_udp",
    "local_address": "0.0.0.0",
    "local_port": ${current_port},
    "timeout": 60,
    "udp_timeout": 60,
    "fast_open": true,
    "workers": 10,
    "reuse_port": true
}
EOF

    # Start shadowsocks client for each server
    nohup ss-local -c "$config_file" > /tmp/ss-local-${current_port}.log 2>&1 &
done

# Print the results
echo -e "\nServer configurations for session ${timestamp}:"
echo "====================="
for i in "${!ip_addresses[@]}"; do
    server_num=$((i + 1))
    current_port=$((start_port + i))
    echo "studentart.cloud:${current_port}"
done
echo "====================="
echo -e "\nLogs available at /tmp/ss-local-*-${timestamp}.log"
