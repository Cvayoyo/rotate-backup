#!/bin/bash

# Array of IP addresse
declare -a ip_addresses=("35.231.100.185" "34.73.218.171" "35.188.240.132" "34.150.128.62" "35.196.83.194" "34.170.143.182" "34.75.175.243" "34.75.31.46" "34.74.42.64" "34.132.228.95" "35.194.71.39" "34.48.99.96" "34.74.196.128" "35.237.12.195" "35.197.99.194" "35.247.107.59" "35.188.253.224" "35.225.173.134" "35.245.4.104" "34.69.212.128" "35.185.194.42" "34.169.250.114" "35.196.56.83" "35.185.98.36" "34.83.154.145" "35.199.189.90" "34.30.47.125" "34.69.209.96" "35.226.111.105" "34.121.61.144" "34.169.105.168" "35.233.253.0" "34.23.50.54" "34.23.39.78" "35.245.82.94" "35.236.226.232" "34.86.161.193" "34.145.174.24" "34.59.82.119" "" "35.230.48.250" "34.169.120.43" "34.86.236.89" "35.245.87.110" "34.82.39.6" "34.169.9.253" "34.148.182.112" "34.73.40.170" "35.243.238.77" "35.196.23.0" "34.23.4.51" "34.138.22.84" "34.19.57.199" "35.202.102.186" "35.247.38.243" "34.136.231.225" "34.73.38.235" "34.148.200.197" "34.74.83.8" "35.237.37.128" "35.233.150.64" "35.247.46.189" "35.237.255.231" "34.73.170.75" "34.58.244.20" "130.211.127.237" "34.55.214.129" "34.31.208.117" "34.82.13.30" "34.105.76.185" "34.19.124.122" "34.19.36.38" "34.73.244.189" "34.73.16.162" "34.172.107.7" "34.10.118.164" "35.223.79.43" "35.239.84.178" "34.82.135.220" "34.83.127.104" "34.86.55.243" "" "34.168.52.27" "104.196.251.179" "35.185.110.90" "35.196.86.210" "34.73.223.170" "34.73.110.77" "34.31.167.4" "35.226.39.165" "34.74.88.216" "34.23.125.22" "34.63.8.170" "35.193.112.236" "34.74.198.174" "34.138.201.86" "35.184.8.229" "34.172.26.85" "34.85.140.140" "35.221.47.185" "34.48.63.115" "34.86.47.12" "34.48.113.120" "35.245.160.72" "162.222.183.137" "34.122.125.49" "34.168.153.218" "34.145.112.225" "34.75.175.148" "35.190.150.99" "34.75.83.46" "34.23.241.161" "34.150.145.236" "34.150.217.14" "34.148.167.180" "35.243.175.47" "34.48.139.154" "34.21.100.39" "34.71.222.9" "34.61.157.88" "35.185.235.184" "34.169.114.179" "34.63.118.199" "34.46.219.248" "34.127.1.87" "34.105.24.96" "34.31.51.123" "35.193.89.254" "34.122.234.223" "34.56.243.181" "35.192.35.71" "35.225.95.159" "34.74.92.56" "34.148.57.241" "34.21.70.67" "34.145.171.246" "34.83.109.45" "34.168.50.44" "34.71.82.6" "34.170.118.201" "34.9.112.27" "34.68.149.233" "104.198.206.85" "34.42.211.49" "35.237.157.81" "34.139.4.49" "34.21.46.34" "34.48.90.225" "34.168.247.30" "35.199.182.43" "34.41.170.136" "35.222.10.117" "34.53.34.104" "34.53.77.231" "34.10.52.247" "34.173.34.247" "34.56.183.236" "104.198.145.143" "34.171.93.56" "34.67.61.30" "35.230.166.124" "34.86.95.36" "34.19.80.186" "34.169.171.221" "35.199.61.59" "34.145.148.35" "34.85.137.172" "34.21.121.228" "104.198.46.58" "35.223.101.158")

# Base domain name and timestamp
base_domain="ayoyo-studentart.fun"
timestamp=$(date +%m%d%H%M)

# Find the last used port
last_port=$(ss -tln | grep -oE ':1[0-9]{4}' | sed 's/://' | sort -n | tail -n 1)
if [ -z "$last_port" ]; then
    start_port=10000
else
    start_port=$((last_port + 1))
fi

echo "Setting up servers for session ${timestamp}..."
echo "Starting from port: ${start_port}"
echo "-------------------"

# Loop through the IP addresses and create host entries
for i in "${!ip_addresses[@]}"; do
    server_num=$((i + 1))  # Starting from 1
    current_port=$((start_port + i))
    host_alias="s${current_port}-${base_domain}"
    # echo "${ip_addresses[$i]} ${host_alias}" | sudo tee -a /etc/hosts

    # Create shadowsocks config for each server
    config_file="/etc/shadowsocks/${current_port}.json"
    sudo tee "$config_file" > /dev/null <<EOF
{
    "server": "${ip_addresses[$i]}",
    "server_port": 8388,
    "password": "Pass",
    "method": "aes-128-gcm",
    "mode": "tcp_and_udp",
    "local_address": "0.0.0.0",
    "local_port": ${current_port},
    "timeout": 60,
    "udp_timeout": 60,
    "fast_open": true,
    "workers": 10,
    "reuse_port": true
}
EOF

    # Start shadowsocks client for each server
    nohup ss-local -c "$config_file" > /tmp/ss-local-${current_port}.log 2>&1 &
done

# Print the results
echo -e "\nServer configurations for session ${timestamp}:"
echo "====================="
for i in "${!ip_addresses[@]}"; do
    server_num=$((i + 1))
    current_port=$((start_port + i))
    echo "studentart.cloud:${current_port}"
done
echo "====================="
echo -e "\nLogs available at /tmp/ss-local-*-${timestamp}.log"
