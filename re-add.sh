#!/bin/bash

# Array of IP addresse
declare -a ip_addresses=("35.245.22.61" "35.245.45.36" "34.145.156.98" "34.86.56.213" "34.10.170.134" "34.70.68.113" "130.211.234.46" "34.58.162.11" "35.196.9.125" "104.196.62.101" "34.21.125.155" "35.236.231.162" "34.60.209.222" "34.123.240.151" "34.60.238.242" "35.238.110.132" "35.237.0.29" "34.23.214.91" "34.138.113.60" "34.139.179.64" "34.85.199.55" "34.86.68.95" "34.145.169.25" "34.145.139.19" "34.23.2.219" "34.23.82.137" "34.48.73.166" "35.245.207.50" "35.239.231.176" "34.132.71.43" "34.48.95.4" "34.48.99.24" "35.227.51.198" "35.237.78.44" "104.197.126.26" "34.72.30.47" "34.31.145.82" "35.192.7.104" "34.41.13.30" "104.197.233.25" "34.63.86.60" "34.173.126.53" "34.139.136.79" "35.231.53.166" "34.145.201.20" "35.245.7.50" "34.145.159.97" "34.122.112.244" "34.145.245.77" "34.135.11.14" "34.70.116.110" "34.28.155.182" "34.41.69.225" "34.30.222.79" "34.48.142.38" "34.150.215.217" "34.48.215.6" "35.245.169.160" "34.74.119.65" "34.86.182.25" "34.21.55.119" "35.223.81.217" "34.121.196.144" "104.198.136.163" "34.61.215.128" "34.122.137.241" "34.16.115.248" "34.61.140.246" "34.173.135.17" "34.133.38.215" "34.59.123.154" "34.48.134.139" "35.221.43.225" "35.185.16.76" "34.139.17.50" "35.190.160.161" "34.23.217.241" "35.236.234.93" "34.21.83.133" "34.27.43.230" "104.197.217.160" "34.134.68.119" "104.154.181.248" "34.55.181.157" "34.145.219.166" "34.29.163.146" "34.21.56.107" "34.60.76.243" "34.46.68.205" "35.199.44.133" "34.145.173.239" "35.243.224.41" "35.243.228.125" "35.231.32.84" "35.185.94.164" "34.28.158.77" "34.59.77.53" "34.58.46.195" "34.122.199.105" "34.44.141.21" "34.30.179.58" "34.86.159.107" "34.86.214.127" "34.139.182.53" "34.73.138.49" "34.75.30.58" "35.231.28.122" "104.154.224.249" "34.59.94.26" "35.224.44.162" "34.66.174.28" "34.23.111.205" "34.139.89.191" "34.61.38.201" "34.61.218.198" "34.10.162.229" "35.227.70.211" "35.227.98.253" "35.188.95.85" "34.31.88.116" "34.21.17.93" "34.48.155.186" "104.198.159.40" "35.225.46.63" "34.61.31.34" "34.71.94.137" "35.221.20.173" "34.85.248.225" "35.196.208.105" "34.138.25.7" "34.145.155.31" "35.188.237.233" "34.63.242.243" "34.69.158.248" "34.148.39.211" "35.190.140.170" "34.138.65.96" "35.237.88.18" "34.85.176.53" "35.245.221.36" "35.188.246.35" "35.236.205.12" "34.27.209.160" "34.59.121.179" "35.230.165.40" "34.145.240.205" "34.150.251.161" "35.245.77.78" "34.122.244.119" "107.178.208.163" "104.196.30.56" "34.139.54.56" "34.173.77.215" "34.28.172.116" "34.48.144.174" "34.145.245.189" "35.221.32.79" "34.21.73.45" "35.225.120.67" "34.31.77.192" "34.48.20.29" "35.245.48.127" "104.196.196.32" "35.227.115.56" "34.9.233.126" "34.173.91.43" "34.48.102.100" "34.21.113.207" "34.138.106.120" "34.148.126.136" "34.55.118.158" "34.172.148.1" "34.31.159.86" "34.61.159.115" "34.57.220.74" "34.132.223.65" "34.145.181.60" "34.48.106.144")

# Base domain name and timestamp
base_domain="ayoyo-studentart.fun"
timestamp=$(date +%m%d%H%M)

# Find the last used port
last_port=$(ss -tln | grep -oE ':1[0-9]{4}' | sed 's/://' | sort -n | tail -n 1)
if [ -z "$last_port" ]; then
    start_port=10000
else
    start_port=$((last_port + 1))
fi

echo "Setting up servers for session ${timestamp}..."
echo "Starting from port: ${start_port}"
echo "-------------------"

# Loop through the IP addresses and create host entries
for i in "${!ip_addresses[@]}"; do
    server_num=$((i + 1))  # Starting from 1
    current_port=$((start_port + i))
    host_alias="s${current_port}-${base_domain}"
    # echo "${ip_addresses[$i]} ${host_alias}" | sudo tee -a /etc/hosts

    # Create shadowsocks config for each server
    config_file="/etc/shadowsocks/${current_port}.json"
    sudo tee "$config_file" > /dev/null <<EOF
{
    "server": "${ip_addresses[$i]}",
    "server_port": 8388,
    "password": "Pass",
    "method": "aes-128-gcm",
    "mode": "tcp_and_udp",
    "local_address": "0.0.0.0",
    "local_port": ${current_port},
    "timeout": 60,
    "udp_timeout": 60,
    "fast_open": true,
    "workers": 10,
    "reuse_port": true
}
EOF

    # Start shadowsocks client for each server
    nohup ss-local -c "$config_file" > /tmp/ss-local-${current_port}.log 2>&1 &
done

# Print the results
echo -e "\nServer configurations for session ${timestamp}:"
echo "====================="
for i in "${!ip_addresses[@]}"; do
    server_num=$((i + 1))
    current_port=$((start_port + i))
    echo "studentart.cloud:${current_port}"
done
echo "====================="
echo -e "\nLogs available at /tmp/ss-local-*-${timestamp}.log"
