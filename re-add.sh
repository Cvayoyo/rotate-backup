#!/bin/bash

# Array of IP addresse
declare -a ip_addresses=("34.48.29.100" "34.86.141.214" "34.86.112.221" "34.71.57.195" "35.245.194.131" "35.223.186.93" "34.48.153.85" "34.150.182.152" "35.194.72.129" "34.86.46.153" "34.63.236.24" "104.197.108.135" "34.135.179.141" "34.27.242.39" "104.198.40.173" "34.121.14.61" "34.145.237.140" "34.48.214.68" "34.74.62.70" "34.23.58.180" "35.238.151.119" "34.46.95.1" "34.56.84.60" "34.66.73.220" "34.9.49.230" "34.133.132.132" "34.74.46.60" "34.73.134.47" "34.21.43.43" "35.194.72.131" "35.227.32.52" "34.74.96.63" "34.46.170.95" "34.28.196.224" "34.136.174.178" "34.69.71.50" "35.245.30.66" "34.85.213.2" "34.138.168.50" "34.71.58.145" "34.29.238.96" "34.139.157.247" "34.148.157.23" "34.66.248.242" "34.61.162.159" "34.41.73.114" "34.74.132.21" "35.224.193.244" "34.86.127.163" "35.245.185.103" "34.123.156.24" "34.55.183.23" "34.139.197.176" "34.23.114.242" "34.138.161.113" "35.229.82.206" "34.45.16.92" "35.192.167.163" "35.245.121.181" "35.236.251.7" "34.60.59.69" "34.61.158.139" "34.75.221.164" "35.231.17.117" "34.85.223.79" "34.21.88.209" "34.57.125.105" "35.230.167.116" "35.224.198.137" "34.86.248.83" "34.48.22.232" "35.231.165.31" "34.48.28.121" "35.237.138.161" "34.139.235.96" "35.237.177.82" "34.46.74.89" "35.193.159.237" "34.136.15.43" "34.61.184.69" "34.48.69.18" "35.221.19.109" "34.150.137.36" "34.86.133.86" "34.21.2.49" "34.86.131.97" "34.86.185.194" "34.86.243.68" "35.196.68.19" "34.75.136.93" "34.122.232.77" "34.29.30.184" "35.245.85.234" "34.21.79.71" "34.86.146.90" "35.245.92.173" "34.148.244.245" "34.139.179.75" "34.171.45.233" "34.58.154.201" "34.74.113.106" "35.229.65.108" "34.86.243.145" "34.86.137.11" "34.145.186.100" "34.145.131.108" "35.196.145.236" "34.48.37.105" "34.21.74.118" "34.27.192.241" "35.226.248.25" "35.237.221.30" "34.148.3.136" "35.192.57.221" "35.193.16.4" "34.21.58.68" "34.48.125.151" "34.63.99.91" "34.9.182.95" "35.230.167.120" "34.21.67.87" "34.75.246.205" "104.196.165.224" "34.75.155.253" "35.237.237.33" "35.237.215.46" "35.227.119.12" "35.184.243.246" "34.9.110.236" "34.133.60.199" "34.30.59.183" "35.196.152.106" "34.61.159.113" "35.227.80.251" "34.56.172.41" "34.74.188.101" "35.196.122.229" "35.185.124.162" "34.138.12.209" "34.70.160.90" "34.27.91.147" "34.86.210.241" "34.48.138.195" "34.85.168.228" "34.21.75.0" "34.27.86.65" "34.29.121.75" "34.86.39.1" "34.21.60.32" "34.73.0.14" "34.139.200.28" "34.86.11.115" "35.245.35.175" "34.139.201.199" "34.73.10.212" "104.198.69.17" "34.57.79.72" "104.196.134.195" "35.196.248.151" "34.121.231.189" "104.155.128.166" "34.150.132.190" "35.230.170.252" "34.10.212.186" "34.48.61.215" "35.245.183.144" "34.45.227.138" "34.42.235.172" "34.61.113.153" "35.196.155.143" "34.138.142.99" "34.73.103.75" "34.73.197.170" "34.44.25.160" "34.29.39.106" "34.10.81.161" "35.202.4.99" "35.238.114.25" "35.188.31.111")

# Base domain name and timestamp
base_domain="ayoyo-studentart.fun"
timestamp=$(date +%m%d%H%M)

# Find the last used port
last_port=$(ss -tln | grep -oE ':1[0-9]{4}' | sed 's/://' | sort -n | tail -n 1)
if [ -z "$last_port" ]; then
    start_port=10000
else
    start_port=$((last_port + 1))
fi

echo "Setting up servers for session ${timestamp}..."
echo "Starting from port: ${start_port}"
echo "-------------------"

# Loop through the IP addresses and create host entries
for i in "${!ip_addresses[@]}"; do
    server_num=$((i + 1))  # Starting from 1
    current_port=$((start_port + i))
    host_alias="s${current_port}-${base_domain}"
    # echo "${ip_addresses[$i]} ${host_alias}" | sudo tee -a /etc/hosts

    # Create shadowsocks config for each server
    config_file="/etc/shadowsocks/${current_port}.json"
    sudo tee "$config_file" > /dev/null <<EOF
{
    "server": "${ip_addresses[$i]}",
    "server_port": 8388,
    "password": "Pass",
    "method": "aes-128-gcm",
    "mode": "tcp_and_udp",
    "local_address": "0.0.0.0",
    "local_port": ${current_port},
    "timeout": 60,
    "udp_timeout": 60,
    "fast_open": true,
    "workers": 10,
    "reuse_port": true
}
EOF

    # Start shadowsocks client for each server
    nohup ss-local -c "$config_file" > /tmp/ss-local-${current_port}.log 2>&1 &
done

# Print the results
echo -e "\nServer configurations for session ${timestamp}:"
echo "====================="
for i in "${!ip_addresses[@]}"; do
    server_num=$((i + 1))
    current_port=$((start_port + i))
    echo "studentart.cloud:${current_port}"
done
echo "====================="
echo -e "\nLogs available at /tmp/ss-local-*-${timestamp}.log"
