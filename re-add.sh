#!/bin/bash

# Array of IP addresse
declare -a ip_addresses=("34.86.104.55" "35.245.126.106" "104.196.126.36" "35.196.18.157" "34.83.95.235" "34.169.246.102" "34.105.105.147" "35.197.127.215" "34.23.236.229" "34.74.19.119" "35.243.218.112" "34.139.224.78" "34.75.191.21" "34.148.237.231" "34.169.4.77" "35.185.225.242" "34.61.77.141" "34.41.74.42" "34.134.27.65" "34.42.163.78" "35.245.225.31" "34.145.255.153" "34.74.220.128" "34.75.143.156" "35.196.25.218" "34.150.159.34" "34.21.9.250" "34.63.133.161" "34.31.107.29" "34.83.156.119" "35.233.135.5" "104.196.224.149" "35.197.83.172" "34.83.199.163" "34.145.106.176" "34.172.251.180" "34.61.106.183" "34.21.82.70" "34.21.91.190" "34.134.192.7" "34.63.214.120" "34.67.10.199" "34.57.27.79" "35.245.136.131" "34.86.113.56" "35.236.252.39" "34.48.53.176" "35.237.216.190" "35.196.69.226" "34.73.19.20" "34.75.184.148" "34.48.170.253" "35.245.208.222" "34.45.74.152" "34.46.223.60" "34.48.145.52" "34.145.234.43" "34.46.55.44" "34.42.224.228" "34.72.66.28" "34.61.239.127" "35.243.142.72" "34.148.26.120" "34.148.137.244" "104.196.26.42" "34.169.173.201" "34.169.86.105" "34.74.151.66" "34.75.7.160" "35.225.175.226" "34.10.116.107" "34.19.11.47" "34.86.53.108" "34.86.153.33" "34.74.236.188" "34.148.232.142" "35.229.120.138" "34.148.178.245" "35.185.225.80" "34.168.92.124" "34.59.59.123" "35.238.50.250" "34.85.240.153" "35.236.234.65" "34.42.239.36" "34.29.13.150" "34.168.47.90" "34.127.104.139" "34.21.49.216" "34.85.128.163" "34.127.102.172" "34.127.7.77" "34.83.166.212" "34.105.119.78" "34.75.192.111" "34.138.59.43" "34.73.210.138" "34.148.168.156" "35.237.175.8" "34.74.142.101" "34.21.127.5" "34.145.233.175" "34.123.106.171" "34.42.103.8" "34.19.125.177" "34.82.60.228" "35.230.116.24" "34.19.81.42" "34.145.143.91" "34.86.248.43" "35.230.170.159" "34.48.123.102" "34.30.49.213" "34.173.15.209" "34.53.53.12" "35.233.161.243" "104.198.2.10" "34.105.10.93" "104.199.117.111" "35.230.24.249" "35.229.55.33" "104.196.193.40" "35.193.42.21" "34.123.3.167" "34.86.117.206" "34.145.175.231" "34.85.237.193" "34.48.102.70" "34.48.23.81" "34.86.19.183" "35.197.89.249" "34.168.106.82" "35.185.222.57" "34.82.219.252" "34.74.54.183" "34.139.182.224" "35.227.119.228" "35.196.95.226" "34.127.125.221" "34.127.13.51" "34.21.10.71" "34.21.72.92" "34.10.168.4" "34.63.59.198" "35.231.141.8" "35.196.187.176" "35.231.232.198" "34.139.120.166" "35.229.112.242" "35.185.49.209" "34.134.212.205" "35.232.134.100" "35.233.255.74" "34.169.179.176" "104.196.67.249" "35.237.16.126" "34.44.212.16" "34.55.161.219" "34.123.200.132" "34.44.142.114" "35.230.62.207" "34.127.52.194" "35.231.190.23" "34.148.161.7" "34.53.8.155" "35.230.69.186" "34.172.220.243" "34.56.217.172" "34.168.192.166" "34.82.229.232" "34.74.102.5" "35.231.54.163" "34.27.129.53" "34.63.247.173" "34.82.33.127" "35.203.187.233" "35.230.106.138" "34.82.147.139" "34.168.92.112" "34.82.213.149" "34.170.52.121" "34.66.229.198" "34.48.138.167" "34.145.209.61" "34.85.201.91" "34.86.205.143" "34.42.139.0" "34.59.227.228" "34.86.205.187" "34.145.159.70" "35.236.221.221" "35.236.219.111" "34.105.83.40" "34.168.80.74" "34.145.236.58" "34.48.64.230" "35.233.249.213" "34.82.39.73" "34.85.143.81" "34.21.91.178" "34.56.244.152" "35.239.52.67" "35.231.62.95" "35.196.235.63" "34.23.92.95" "35.190.132.179" "34.60.162.42" "34.70.156.236" "104.196.105.197" "34.75.40.57" "34.48.120.39" "34.150.208.152" "34.145.248.4" "34.21.36.4" "34.138.60.65" "34.75.179.139" "34.60.106.188" "35.225.41.123" "34.23.42.156" "35.196.72.234" "34.19.52.17" "34.82.58.182" "34.138.29.45" "34.138.102.55" "35.193.211.219" "35.225.210.41" "34.28.157.198" "34.42.133.139" "34.21.43.74" "35.221.34.130" "35.227.64.143" "35.237.124.254" "34.61.32.128" "34.55.210.202")

# Base domain name and timestamp
base_domain="ayoyo-studentart.fun"
timestamp=$(date +%m%d%H%M)

# Find the last used port
last_port=$(ss -tln | grep -oE ':1[0-9]{4}' | sed 's/://' | sort -n | tail -n 1)
if [ -z "$last_port" ]; then
    start_port=10000
else
    start_port=$((last_port + 1))
fi

echo "Setting up servers for session ${timestamp}..."
echo "Starting from port: ${start_port}"
echo "-------------------"

# Loop through the IP addresses and create host entries
for i in "${!ip_addresses[@]}"; do
    server_num=$((i + 1))  # Starting from 1
    current_port=$((start_port + i))
    host_alias="s${current_port}-${base_domain}"
    # echo "${ip_addresses[$i]} ${host_alias}" | sudo tee -a /etc/hosts

    # Create shadowsocks config for each server
    config_file="/etc/shadowsocks/${current_port}.json"
    sudo tee "$config_file" > /dev/null <<EOF
{
    "server": "${ip_addresses[$i]}",
    "server_port": 8388,
    "password": "Pass",
    "method": "aes-128-gcm",
    "mode": "tcp_and_udp",
    "local_address": "0.0.0.0",
    "local_port": ${current_port},
    "timeout": 60,
    "udp_timeout": 60,
    "fast_open": true,
    "workers": 10,
    "reuse_port": true
}
EOF

    # Start shadowsocks client for each server
    nohup ss-local -c "$config_file" > /tmp/ss-local-${current_port}.log 2>&1 &
done

# Print the results
echo -e "\nServer configurations for session ${timestamp}:"
echo "====================="
for i in "${!ip_addresses[@]}"; do
    server_num=$((i + 1))
    current_port=$((start_port + i))
    echo "studentart.cloud:${current_port}"
done
echo "====================="
echo -e "\nLogs available at /tmp/ss-local-*-${timestamp}.log"
